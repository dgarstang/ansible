- name: Install base packages
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  loop: "{{ base_packages }}"

- name: Install pi4 temperature checking script
  ansible.builtin.copy:
    src: files/check_temp.py
    dest: /usr/local/bin
    owner: root
    group: root
    mode: '0755'

- name: Install cron job to run pi4 check temperature script
  ansible.builtin.cron:
    name: "Check CPU temperature"
    minute: "0/1"
    job: "$PATH:/usr/local/bin /usr/local/bin/check_temp.py -u {{ smtp_user }} -p {{ smtp_password }} -r {{ smtp_user }}"

- name: Install monitoring packages
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  loop: "{{ monitoring_packages }}"

- name: Download grafana repository key
  ansible.builtin.get_url:
    url: https://apt.grafana.com/gpg.key
    dest: /usr/share/keyrings/grafana.key
    mode: '0644'

- name: grafana | apt source
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/grafana.key] https://apt.grafana.com stable main"
    state: present

- name: Install grafana agent
  ansible.builtin.package:
    name: grafana-agent
    state: present

- name: Update /etc/hosts file
  lineinfile:
    path: /etc/hosts
    line: "{{ hostvars[item]['ansible_default_ipv4']['address'] }} {{ hostvars[item]['ansible_hostname'] }}"
    state: present
    regexp: "^{{ hostvars[item]['ansible_default_ipv4']['address'] }}"
  loop: "{{ groups['all'] }}"
